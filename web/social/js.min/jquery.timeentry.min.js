(function(a){function e(){this._disabledInputs=[];this.regional=[];this.regional[""]={show24Hours:false,separator:":",ampmPrefix:"",ampmNames:["AM","PM"],spinnerTexts:["Now","Previous field","Next field","Increment","Decrement"]};this._defaults={appendText:"",showSeconds:false,timeSteps:[1,1,1],initialField:0,noSeparatorEntry:false,useMouseWheel:true,defaultTime:null,minTime:null,maxTime:null,spinnerImage:AbsolutePath+"/images/spinnerGreen.png",spinnerSize:[20,20,8],spinnerBigImage:"",spinnerBigSize:[40,40,16],spinnerIncDecOnly:false,spinnerRepeat:[500,250],beforeShow:null,beforeSetTime:null};a.extend(this._defaults,this.regional[""])}a.extend(e.prototype,{markerClassName:"hasTimeEntry",propertyName:"timeEntry",_appendClass:"timeEntry_append",_controlClass:"timeEntry_control",_expandClass:"timeEntry_expand",setDefaults:function(f){a.extend(this._defaults,f||{});return this},_attachPlugin:function(i,h){var f=a(i);if(f.hasClass(this.markerClassName)){return}var g={options:a.extend({},this._defaults,h),input:f,_field:0,_selectedHour:0,_selectedMinute:0,_selectedSecond:0};f.data(this.propertyName,g).addClass(this.markerClassName).bind("focus."+this.propertyName,this._doFocus).bind("blur."+this.propertyName,this._doBlur).bind("click."+this.propertyName,this._doClick).bind("keydown."+this.propertyName,this._doKeyDown).bind("keypress."+this.propertyName,this._doKeyPress).bind("paste."+this.propertyName,function(j){setTimeout(function(){d._parseTime(g)},1)});this._optionPlugin(i,h)},_optionPlugin:function(k,i,l){k=a(k);var g=k.data(this.propertyName);if(!i||(typeof i=="string"&&l==null)){var h=i;i=(g||{}).options;return(i&&h?i[h]:i)}if(!k.hasClass(this.markerClassName)){return}i=i||{};if(typeof i=="string"){var h=i;i={};i[h]=l}var f=this._extractTime(g);a.extend(g.options,i);g._field=0;if(f){this._setTime(g,new Date(0,0,0,f[0],f[1],f[2]))}k.next("span."+this._appendClass).remove();k.parent().find("span."+this._controlClass).remove();if(a.fn.mousewheel){k.unmousewheel()}var j=(!g.options.spinnerImage?null:a('<span class="'+this._controlClass+'" style="display: inline-block; background: url(\''+g.options.spinnerImage+"') 0 0 no-repeat; width: "+g.options.spinnerSize[0]+"px; height: "+g.options.spinnerSize[1]+'px;"></span>'));k.after(g.options.appendText?'<span class="'+this._appendClass+'">'+g.options.appendText+"</span>":"").after(j||"");if(g.options.useMouseWheel&&a.fn.mousewheel){k.mousewheel(this._doMouseWheel)}if(j){j.mousedown(this._handleSpinner).mouseup(this._endSpinner).mouseover(this._expandSpinner).mouseout(this._endSpinner).mousemove(this._describeSpinner)}},_enablePlugin:function(f){this._enableDisable(f,false)},_disablePlugin:function(f){this._enableDisable(f,true)},_enableDisable:function(h,f){var g=a.data(h,this.propertyName);if(!g){return}h.disabled=f;if(h.nextSibling&&h.nextSibling.nodeName.toLowerCase()=="span"){d._changeSpinner(g,h.nextSibling,(f?5:-1))}d._disabledInputs=a.map(d._disabledInputs,function(i){return(i==h?null:i)});if(f){d._disabledInputs.push(h)}},_isDisabledPlugin:function(f){return a.inArray(f,this._disabledInputs)>-1},_destroyPlugin:function(f){f=a(f);if(!f.hasClass(this.markerClassName)){return}f.removeClass(this.markerClassName).removeData(this.propertyName).unbind("."+this.propertyName);if(a.fn.mousewheel){f.unmousewheel()}this._disabledInputs=a.map(this._disabledInputs,function(g){return(g==f[0]?null:g)});f.siblings("."+this._appendClass+",."+this._controlClass).remove()},_setTimePlugin:function(g,h){var f=a.data(g,this.propertyName);if(f){if(h===null||h===""){f.input.val("")}else{this._setTime(f,h?(typeof h=="object"?new Date(h.getTime()):h):null)}}},_getTimePlugin:function(h){var g=a.data(h,this.propertyName);var f=(g?this._extractTime(g):null);return(!f?null:new Date(0,0,0,f[0],f[1],f[2]))},_getOffsetPlugin:function(h){var g=a.data(h,this.propertyName);var f=(g?this._extractTime(g):null);return(!f?0:(f[0]*3600+f[1]*60+f[2])*1000)},_doFocus:function(h){var f=(h.nodeName&&h.nodeName.toLowerCase()=="input"?h:this);if(d._lastInput==f||d._isDisabledPlugin(f)){d._focussed=false;return}var g=a.data(f,d.propertyName);d._focussed=true;d._lastInput=f;d._blurredInput=null;a.extend(g.options,(a.isFunction(g.options.beforeShow)?g.options.beforeShow.apply(f,[f]):{}));d._parseTime(g);setTimeout(function(){d._showField(g)},10)},_doBlur:function(f){d._blurredInput=d._lastInput;d._lastInput=null},_doClick:function(h){var k=h.target;var l=a.data(k,d.propertyName);if(!d._focussed){var j=l.options.separator.length+2;l._field=0;if(k.selectionStart!=null){for(var i=0;i<=Math.max(1,l._secondField,l._ampmField);i++){var g=(i!=l._ampmField?(i*j)+2:(l._ampmField*j)+l.options.ampmPrefix.length+l.options.ampmNames[0].length);l._field=i;if(k.selectionStart<g){break}}}else{if(k.createTextRange){var o=a(h.srcElement);var n=k.createTextRange();var f=function(p){return{thin:2,medium:4,thick:6}[p]||p};var m=h.clientX+document.documentElement.scrollLeft-(o.offset().left+parseInt(f(o.css("border-left-width")),10))-n.offsetLeft;for(var i=0;i<=Math.max(1,l._secondField,l._ampmField);i++){var g=(i!=l._ampmField?(i*j)+2:(l._ampmField*j)+l.options.ampmPrefix.length+l.options.ampmNames[0].length);n.collapse();n.moveEnd("character",g);l._field=i;if(m<n.boundingWidth){break}}}}}d._showField(l);d._focussed=false},_doKeyDown:function(f){if(f.keyCode>=48){return true}var g=a.data(f.target,d.propertyName);switch(f.keyCode){case 9:return(f.shiftKey?d._changeField(g,-1,true):d._changeField(g,+1,true));case 35:if(f.ctrlKey){d._setValue(g,"")}else{g._field=Math.max(1,g._secondField,g._ampmField);d._adjustField(g,0)}break;case 36:if(f.ctrlKey){d._setTime(g)}else{g._field=0;d._adjustField(g,0)}break;case 37:d._changeField(g,-1,false);break;case 38:d._adjustField(g,+1);break;case 39:d._changeField(g,+1,false);break;case 40:d._adjustField(g,-1);break;case 46:d._setValue(g,"");break;default:return true}return false},_doKeyPress:function(g){var f=String.fromCharCode(g.charCode==undefined?g.keyCode:g.charCode);if(f<" "){return true}var h=a.data(g.target,d.propertyName);d._handleKeyPress(h,f);return false},_doMouseWheel:function(g,f){if(d._isDisabledPlugin(g.target)){return}var h=a.data(g.target,d.propertyName);h.input.focus();if(!h.input.val()){d._parseTime(h)}d._adjustField(h,f);g.preventDefault()},_expandSpinner:function(f){var j=d._getSpinnerTarget(f);var g=a.data(d._getInput(j),d.propertyName);if(d._isDisabledPlugin(g.input[0])){return}if(g.options.spinnerBigImage){g._expanded=true;var h=a(j).offset();var i=null;a(j).parents().each(function(){var k=a(this);if(k.css("position")=="relative"||k.css("position")=="absolute"){i=k.offset()}return !i});a('<div class="'+d._expandClass+'" style="position: absolute; left: '+(h.left-(g.options.spinnerBigSize[0]-g.options.spinnerSize[0])/2-(i?i.left:0))+"px; top: "+(h.top-(g.options.spinnerBigSize[1]-g.options.spinnerSize[1])/2-(i?i.top:0))+"px; width: "+g.options.spinnerBigSize[0]+"px; height: "+g.options.spinnerBigSize[1]+"px; background: transparent url("+g.options.spinnerBigImage+') no-repeat 0px 0px; z-index: 10;"></div>').mousedown(d._handleSpinner).mouseup(d._endSpinner).mouseout(d._endExpand).mousemove(d._describeSpinner).insertAfter(j)}},_getInput:function(f){return a(f).siblings("."+d.markerClassName)[0]},_describeSpinner:function(f){var h=d._getSpinnerTarget(f);var g=a.data(d._getInput(h),d.propertyName);h.title=g.options.spinnerTexts[d._getSpinnerRegion(g,f)]},_handleSpinner:function(f){var j=d._getSpinnerTarget(f);var g=d._getInput(j);if(d._isDisabledPlugin(g)){return}if(g==d._blurredInput){d._lastInput=g;d._blurredInput=null}var h=a.data(g,d.propertyName);d._doFocus(g);var i=d._getSpinnerRegion(h,f);d._changeSpinner(h,j,i);d._actionSpinner(h,i);d._timer=null;d._handlingSpinner=true;if(i>=3&&h.options.spinnerRepeat[0]){d._timer=setTimeout(function(){d._repeatSpinner(h,i)},h.options.spinnerRepeat[0]);a(j).one("mouseout",d._releaseSpinner).one("mouseup",d._releaseSpinner)}},_actionSpinner:function(f,g){if(!f.input.val()){d._parseTime(f)}switch(g){case 0:this._setTime(f);break;case 1:this._changeField(f,-1,false);break;case 2:this._changeField(f,+1,false);break;case 3:this._adjustField(f,+1);break;case 4:this._adjustField(f,-1);break}},_repeatSpinner:function(f,g){if(!d._timer){return}d._lastInput=d._blurredInput;this._actionSpinner(f,g);this._timer=setTimeout(function(){d._repeatSpinner(f,g)},f.options.spinnerRepeat[1])},_releaseSpinner:function(f){clearTimeout(d._timer);d._timer=null},_endExpand:function(f){d._timer=null;var i=d._getSpinnerTarget(f);var g=d._getInput(i);var h=a.data(g,d.propertyName);a(i).remove();h._expanded=false},_endSpinner:function(f){d._timer=null;var i=d._getSpinnerTarget(f);var g=d._getInput(i);var h=a.data(g,d.propertyName);if(!d._isDisabledPlugin(g)){d._changeSpinner(h,i,-1)}if(d._handlingSpinner){d._lastInput=d._blurredInput}if(d._lastInput&&d._handlingSpinner){d._showField(h)}d._handlingSpinner=false},_getSpinnerTarget:function(f){return f.target||f.srcElement},_getSpinnerRegion:function(h,g){var n=this._getSpinnerTarget(g);var k=a(n).offset();var m=[document.documentElement.scrollLeft||document.body.scrollLeft,document.documentElement.scrollTop||document.body.scrollTop];var i=(h.options.spinnerIncDecOnly?99:g.clientX+m[0]-k.left);var p=g.clientY+m[1]-k.top;var o=h.options[h._expanded?"spinnerBigSize":"spinnerSize"];var l=(h.options.spinnerIncDecOnly?99:o[0]-1-i);var f=o[1]-1-p;if(o[2]>0&&Math.abs(i-l)<=o[2]&&Math.abs(p-f)<=o[2]){return 0}var j=Math.min(i,p,l,f);return(j==i?1:(j==l?2:(j==p?3:4)))},_changeSpinner:function(f,h,g){a(h).css("background-position","-"+((g+1)*f.options[f._expanded?"spinnerBigSize":"spinnerSize"][0])+"px 0px")},_parseTime:function(g){var f=this._extractTime(g);if(f){g._selectedHour=f[0];g._selectedMinute=f[1];g._selectedSecond=f[2]}else{var h=this._constrainTime(g);g._selectedHour=h[0];g._selectedMinute=h[1];g._selectedSecond=(g.options.showSeconds?h[2]:0)}g._secondField=(g.options.showSeconds?2:-1);g._ampmField=(g.options.show24Hours?-1:(g.options.showSeconds?3:2));g._lastChr="";g._field=Math.max(0,Math.min(Math.max(1,g._secondField,g._ampmField),g.options.initialField));if(g.input.val()!=""){this._showTime(g)}},_extractTime:function(h,m){m=m||h.input.val();var f=m.split(h.options.separator);if(h.options.separator==""&&m!=""){f[0]=m.substring(0,2);f[1]=m.substring(2,4);f[2]=m.substring(4,6)}if(f.length>=2){var i=!h.options.show24Hours&&(m.indexOf(h.options.ampmNames[0])>-1);var j=!h.options.show24Hours&&(m.indexOf(h.options.ampmNames[1])>-1);var g=parseInt(f[0],10);g=(isNaN(g)?0:g);g=((i||j)&&g==12?0:g)+(j?12:0);var k=parseInt(f[1],10);k=(isNaN(k)?0:k);var l=(f.length>=3?parseInt(f[2],10):0);l=(isNaN(l)||!h.options.showSeconds?0:l);return this._constrainTime(h,[g,k,l])}return null},_constrainTime:function(h,f){var l=(f!=null);if(!l){var j=this._determineTime(h.options.defaultTime,h)||new Date();f=[j.getHours(),j.getMinutes(),j.getSeconds()]}var k=false;for(var g=0;g<h.options.timeSteps.length;g++){if(k){f[g]=0}else{if(h.options.timeSteps[g]>1){f[g]=Math.round(f[g]/h.options.timeSteps[g])*h.options.timeSteps[g];k=true}}}return f},_showTime:function(g){var f=(this._formatNumber(g.options.show24Hours?g._selectedHour:((g._selectedHour+11)%12)+1)+g.options.separator+this._formatNumber(g._selectedMinute)+(g.options.showSeconds?g.options.separator+this._formatNumber(g._selectedSecond):"")+(g.options.show24Hours?"":g.options.ampmPrefix+g.options.ampmNames[(g._selectedHour<12?0:1)]));this._setValue(g,f);this._showField(g)},_showField:function(i){var h=i.input[0];if(i.input.is(":hidden")||d._lastInput!=h){return}var g=i.options.separator.length+2;var k=(i._field!=i._ampmField?(i._field*g):(i._ampmField*g)-i.options.separator.length+i.options.ampmPrefix.length);var f=k+(i._field!=i._ampmField?2:i.options.ampmNames[0].length);if(h.setSelectionRange){h.setSelectionRange(k,f)}else{if(h.createTextRange){var j=h.createTextRange();j.moveStart("character",k);j.moveEnd("character",f-i.input.val().length);j.select()}}if(!h.disabled){h.focus()}},_formatNumber:function(f){return(f<10?"0":"")+f},_setValue:function(f,g){if(g!=f.input.val()){f.input.val(g).trigger("change")}},_changeField:function(g,i,h){var f=(g.input.val()==""||g._field==(i==-1?0:Math.max(1,g._secondField,g._ampmField)));if(!f){g._field+=i}this._showField(g);g._lastChr="";return(f&&h)},_adjustField:function(f,g){if(f.input.val()==""){g=0}this._setTime(f,new Date(0,0,0,f._selectedHour+(f._field==0?g*f.options.timeSteps[0]:0)+(f._field==f._ampmField?g*12:0),f._selectedMinute+(f._field==1?g*f.options.timeSteps[1]:0),f._selectedSecond+(f._field==f._secondField?g*f.options.timeSteps[2]:0)))},_setTime:function(g,j){j=this._determineTime(j,g);var f=this._constrainTime(g,j?[j.getHours(),j.getMinutes(),j.getSeconds()]:null);j=new Date(0,0,0,f[0],f[1],f[2]);var j=this._normaliseTime(j);var i=this._normaliseTime(this._determineTime(g.options.minTime,g));var h=this._normaliseTime(this._determineTime(g.options.maxTime,g));j=(i&&j<i?i:(h&&j>h?h:j));if(a.isFunction(g.options.beforeSetTime)){j=g.options.beforeSetTime.apply(g.input[0],[this._getTimePlugin(g.input[0]),j,i,h])}g._selectedHour=j.getHours();g._selectedMinute=j.getMinutes();g._selectedSecond=j.getSeconds();this._showTime(g)},_determineTime:function(i,f){var g=function(j){var k=new Date();k.setTime(k.getTime()+j*1000);return k};var h=function(n){var j=d._extractTime(f,n);var q=new Date();var k=(j?j[0]:q.getHours());var m=(j?j[1]:q.getMinutes());var p=(j?j[2]:q.getSeconds());if(!j){var o=/([+-]?[0-9]+)\s*(s|S|m|M|h|H)?/g;var l=o.exec(n);while(l){switch(l[2]||"s"){case"s":case"S":p+=parseInt(l[1],10);break;case"m":case"M":m+=parseInt(l[1],10);break;case"h":case"H":k+=parseInt(l[1],10);break}l=o.exec(n)}}q=new Date(0,0,10,k,m,p,0);if(/^!/.test(n)){if(q.getDate()>10){q=new Date(0,0,10,23,59,59)}else{if(q.getDate()<10){q=new Date(0,0,10,0,0,0)}}}return q};return(i?(typeof i=="string"?h(i):(typeof i=="number"?g(i):i)):null)},_normaliseTime:function(f){if(!f){return null}f.setFullYear(1900);f.setMonth(0);f.setDate(0);return f},_handleKeyPress:function(i,f){if(f==i.options.separator){this._changeField(i,+1,false)}else{if(f>="0"&&f<="9"){var j=parseInt(f,10);var n=parseInt(i._lastChr+f,10);var h=(i._field!=0?i._selectedHour:(i.options.show24Hours?(n<24?n:j):(n>=1&&n<=12?n:(j>0?j:i._selectedHour))%12+(i._selectedHour>=12?12:0)));var k=(i._field!=1?i._selectedMinute:(n<60?n:j));var m=(i._field!=i._secondField?i._selectedSecond:(n<60?n:j));var g=this._constrainTime(i,[h,k,m]);this._setTime(i,new Date(0,0,0,g[0],g[1],g[2]));if(i.options.noSeparatorEntry&&i._lastChr){this._changeField(i,+1,false)}else{i._lastChr=f}}else{if(!i.options.show24Hours){f=f.toLowerCase();if((f==i.options.ampmNames[0].substring(0,1).toLowerCase()&&i._selectedHour>=12)||(f==i.options.ampmNames[1].substring(0,1).toLowerCase()&&i._selectedHour<12)){var l=i._field;i._field=i._ampmField;this._adjustField(i,+1);i._field=l;this._showField(i)}}}}}});var b=["getOffset","getTime","isDisabled"];function c(f,g){if(f=="option"&&(g.length==0||(g.length==1&&typeof g[0]=="string"))){return true}return a.inArray(f,b)>-1}a.fn.timeEntry=function(f){var g=Array.prototype.slice.call(arguments,1);if(c(f,g)){return d["_"+f+"Plugin"].apply(d,[this[0]].concat(g))}return this.each(function(){if(typeof f=="string"){if(!d["_"+f+"Plugin"]){throw"Unknown command: "+f}d["_"+f+"Plugin"].apply(d,[this].concat(g))}else{var h=(a.fn.metadata?a(this).metadata():{});d._attachPlugin(this,a.extend({},h,f||{}))}})};var d=a.timeEntry=new e()})(jQuery);