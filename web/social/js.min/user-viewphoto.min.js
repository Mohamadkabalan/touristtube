var canvas,ctx,image,iMouseX,iMouseY=1,theSelection=null,click=false,degree=0,select=false,Masking=false,ma=false,cropImageSrc=[],imageWidth=0,imageHeight=0,originalImageWidth=0,originalImageHeight=0,realImageWidth=0,realImageHeight=0;function setSize(){console.log(imageWidth+"-"+imageHeight);$("#canvas").css({width:imageWidth,height:imageHeight});$("#can").css({width:imageWidth,height:imageHeight})}function cloneCanvas(e){var d=document.createElement("canvas");var c=d.getContext("2d");d.width=e.width;d.height=e.height;c.drawImage(e,0,0);return d}$(document).ready(function(){$(document).on("click","#photo_but",function(){if(!$(this).hasClass("active")){$(this).addClass("active");$("#info_but").removeClass("active");$("#edit_info_part").hide();$("#edit_photo_part").show()}});$(document).on("click","#info_but",function(){if(!$(this).hasClass("active")){$(this).addClass("active");$("#photo_but").removeClass("active");$("#edit_info_part").show();$("#edit_photo_part").hide()}});var c,f;var j=document.getElementById("imgInside");var k=j.src;var h=$(".effectCon");imageWidth=$(".cell").attr("data-ww");imageHeight=$(".cell").attr("data-hh");originalImageWidth=imageWidth;originalImageHeight=imageHeight;realImageWidth=$("#imgInside").attr("data-width");realImageHeight=$("#imgInside").attr("data-height");var m=$('<canvas id="canvas">');var n=m[0].getContext("2d");j.onload=function(){m.attr({width:imageWidth,height:imageHeight});n.drawImage(this,0,0)};var e=m.clone();e[0].getContext("2d").drawImage(j,0,0);$(".cell").html(e);Caman("#canvas",j.src,function(){this.render()});Caman("#can",j.src,function(){this.render()});setSize();if(imageHeight===0||imageHeight===0){var d=document.getElementById("canvas");imageWidth=a.slice(0,a.length-2);imageHeight=b.slice(0,b.length-2)}console.log(imageWidth+"-"+imageHeight);h.click(function(q){var s=$(this);var r=$.trim(s.attr("data-effect"));parent.$(".upload-overlay-loading-fix").show();if(s.hasClass("active")){parent.$(".upload-overlay-loading-fix").hide();return false}h.removeClass("active");s.addClass("active");var p=m.clone();p[0].getContext("2d").drawImage(j,0,0);$(".cell").html(p);Caman(p[0],j.src,function(){if(r==="normal"){this.render(function(){parent.$(".upload-overlay-loading-fix").hide()})}if(r in this){this[r]();this.render(function(){parent.$(".upload-overlay-loading-fix").hide()})}$(".applyRotate").hide();$(".applyRotate").next("span").hide()});console.log(imageWidth+"-"+imageHeight);$("#download").show();$("#reset").show();$("#canvas").attr({width:imageWidth,height:imageHeight});$("#canvas").css({width:imageWidth,height:imageHeight});setSize();select=false});$(document).on("click",".rotateRight,.rotateLeft",function(z){z.preventDefault();$(".edit_eventdate_button_container").hide();if($(this).attr("data-class")==="left"){if(degree===0||degree===360){degree=270}else{degree=degree-90}}else{degree+=90}if(imageWidth===0||imageHeight===0){var s=document.getElementById("canvas");var p=s.style.width;var q=s.style.height;imageWidth=p.slice(0,p.length-2);imageHeight=q.slice(0,q.length-2);console.log(p+"-"+q)}var w=imageWidth,u=imageHeight,x=0,y=0;if(degree>360){degree=90}switch(degree){case 90:w=imageHeight;u=imageWidth;y=imageHeight*(-1);break;case 180:x=imageWidth*(-1);y=imageHeight*(-1);break;case 270:w=imageHeight;u=imageWidth;x=imageWidth*(-1);break}var r=document.getElementById("canvas");var v=r.getContext("2d");console.log("cw : "+w+"ch : "+u);$("#canvas").css({width:w,height:u});r.setAttribute("width",w);r.setAttribute("height",u);v.rotate(degree*Math.PI/180);v.drawImage(j,x,y,imageWidth,imageHeight);$(".applyRotate").show();$(".applyRotate").next("span").show();select=false});$(".crop").click(function(p){p.preventDefault();$(".applyRotate").hide();$(".applyRotate").next("span").hide();Masking=false;if(!select){$(".edit_eventdate_button_container").hide();l(200,200,200,200);select=true}else{$(".edit_eventdate_button_container").show();l(0,0,0,0);select=false}});function o(r,s,q,p){this.x=r;this.y=s;this.w=q;this.h=p;this.px=r;this.py=s;this.csize=0;this.csizeh=3;this.bHow=[false,false,false,false];this.iCSize=[this.csize,this.csize,this.csize,this.csize];this.bDrag=[false,false,false,false];this.bDragAll=false}o.prototype.draw=function(){f.strokeStyle="#000";f.lineWidth=2;f.strokeRect(this.x,this.y,this.w,this.h);if(this.w>0&&this.h>0){if(this.x>0&&this.x<$(".cell").attr("data-ww")&&this.y>0&&this.y<$(".cell").attr("data-hh")){}}f.fillStyle="#fff";f.fillRect(this.x-this.iCSize[0],this.y-this.iCSize[0],this.iCSize[0]*2,this.iCSize[0]*2);f.fillRect(this.x+this.w-this.iCSize[1],this.y-this.iCSize[1],this.iCSize[1]*2,this.iCSize[1]*2);f.fillRect(this.x+this.w-this.iCSize[2],this.y+this.h-this.iCSize[2],this.iCSize[2]*2,this.iCSize[2]*2);f.fillRect(this.x-this.iCSize[3],this.y+this.h-this.iCSize[3],this.iCSize[3]*2,this.iCSize[3]*2)};function g(){if(Masking){return false}f.clearRect(0,0,f.canvas.width,f.canvas.height);f.drawImage(j,0,0,f.canvas.width,f.canvas.height);f.fillStyle="rgba(0, 0, 0, 0)";f.fillRect(0,0,f.canvas.width,f.canvas.height);theSelection.draw()}function l(q,r,s,u){$("#canvas").remove();c=m;console.log(imageHeight+"-"+imageWidth);f=c[0].getContext("2d");c.attr({width:imageWidth,height:imageHeight}).css({width:imageWidth,height:imageHeight});$(".cell").html(c);theSelection=new o(q,r,s,u);$("#canvas").mousemove(function(v){var p=$(c).offset();iMouseX=Math.floor(v.pageX-p.left);iMouseY=Math.floor(v.pageY-p.top);if(theSelection.bDragAll){theSelection.x=iMouseX-theSelection.px;theSelection.y=iMouseY-theSelection.py}for(i=0;i<4;i++){theSelection.bHow[i]=false;theSelection.iCSize[i]=theSelection.csize}if(iMouseX>theSelection.x-theSelection.csizeh&&iMouseX<theSelection.x+theSelection.csizeh&&iMouseY>theSelection.y-theSelection.csizeh&&iMouseY<theSelection.y+theSelection.csizeh){theSelection.bHow[0]=true;theSelection.iCSize[0]=theSelection.csizeh}if(iMouseX>theSelection.x+theSelection.w-theSelection.csizeh&&iMouseX<theSelection.x+theSelection.w+theSelection.csizeh&&iMouseY>theSelection.y-theSelection.csizeh&&iMouseY<theSelection.y+theSelection.csizeh){theSelection.bHow[1]=true;theSelection.iCSize[1]=theSelection.csizeh}if(iMouseX>theSelection.x+theSelection.w-theSelection.csizeh&&iMouseX<theSelection.x+theSelection.w+theSelection.csizeh&&iMouseY>theSelection.y+theSelection.h-theSelection.csizeh&&iMouseY<theSelection.y+theSelection.h+theSelection.csizeh){theSelection.bHow[2]=true;theSelection.iCSize[2]=theSelection.csizeh}if(iMouseX>theSelection.x-theSelection.csizeh&&iMouseX<theSelection.x+theSelection.csizeh&&iMouseY>theSelection.y+theSelection.h-theSelection.csizeh&&iMouseY<theSelection.y+theSelection.h+theSelection.csizeh){theSelection.bHow[3]=true;theSelection.iCSize[3]=theSelection.csizeh}var x,w;if(theSelection.bDrag[0]){var y=iMouseX-theSelection.px;var z=iMouseY-theSelection.py;x=theSelection.w+theSelection.x-y;w=theSelection.h+theSelection.y-z}if(theSelection.bDrag[1]){var y=theSelection.x;var z=iMouseY-theSelection.py;x=iMouseX-theSelection.px-y;w=theSelection.h+theSelection.y-z}if(theSelection.bDrag[2]){var y=theSelection.x;var z=theSelection.y;x=iMouseX-theSelection.px-y;w=iMouseY-theSelection.py-z}if(theSelection.bDrag[3]){var y=iMouseX-theSelection.px;var z=theSelection.y;x=theSelection.w+theSelection.x-y;w=iMouseY-theSelection.py-z}if(x>theSelection.csizeh*2&&w>theSelection.csizeh*2){theSelection.w=x;theSelection.h=w;theSelection.x=y;theSelection.y=z}g()});$("#canvas").mousedown(function(v){var p=$(c).offset();iMouseX=Math.floor(v.pageX-p.left);iMouseY=Math.floor(v.pageY-p.top);theSelection.px=iMouseX-theSelection.x;theSelection.py=iMouseY-theSelection.y;if(theSelection.bHow[0]){theSelection.px=iMouseX-theSelection.x;theSelection.py=iMouseY-theSelection.y}if(theSelection.bHow[1]){theSelection.px=iMouseX-theSelection.x-theSelection.w;theSelection.py=iMouseY-theSelection.y}if(theSelection.bHow[2]){theSelection.px=iMouseX-theSelection.x-theSelection.w;theSelection.py=iMouseY-theSelection.y-theSelection.h}if(theSelection.bHow[3]){theSelection.px=iMouseX-theSelection.x;theSelection.py=iMouseY-theSelection.y-theSelection.h}if(iMouseX>theSelection.x+theSelection.csizeh&&iMouseX<theSelection.x+theSelection.w-theSelection.csizeh&&iMouseY>theSelection.y+theSelection.csizeh&&iMouseY<theSelection.y+theSelection.h-theSelection.csizeh){theSelection.bDragAll=true}for(i=0;i<4;i++){if(theSelection.bHow[i]){theSelection.bDrag[i]=true}}});$("#canvas").mouseup(function(p){theSelection.bDragAll=false;for(i=0;i<4;i++){theSelection.bDrag[i]=false}theSelection.px=0;theSelection.py=0});g()}$(".apply_crop").click(function(q){var s,r;r=document.createElement("canvas");s=r.getContext("2d");if(!theSelection){return false}if(!theSelection.w||!theSelection.h){return false}console.log("cropping image..");$(".edit_eventdate_button_container").show();r.width=theSelection.w;r.height=theSelection.h;if(theSelection.x>0&&theSelection.x<$(".cell").attr("data-ww")&&theSelection.y>0&&theSelection.y<$(".cell").attr("data-hh")){s.drawImage(m[0],theSelection.x,theSelection.y,theSelection.w,theSelection.h,0,0,theSelection.w,theSelection.h);var u=r.toDataURL();cropImageSrc.push(j.src);j.src=u;var p=m.clone();p[0].getContext("2d").drawImage(m[0],0,0);$(".cell").html(p);Caman("#canvas",u,function(){this.render(function(){Masking=true})});$("#download").show();$("#reset").show();$(".applyDiv").hide();imageWidth=theSelection.w;imageHeight=theSelection.h;console.log(imageWidth+"-"+imageHeight);$("#canvas").attr({width:theSelection.w,height:theSelection.h}).css({width:theSelection.w,height:theSelection.h});select=false;console.log("Image Cropped.")}});$("#undoCrop").click(function(u){u.preventDefault();length=cropImageSrc.length;if(length>0){j.src=cropImageSrc[length-1];var s=m.clone();s[0].getContext("2d").drawImage(j,0,0);$(".cell").html(s);Caman("#canvas",j.src,function(){this.render()});cropImageSrc.pop();$("#download").show();$("#reset").show();$(".applyDiv").hide();imageWidth=$(".cell").attr("data-ww");imageHeight=$(".cell").attr("data-hh");if(imageWidth===0||imageHeight===0){var r=document.getElementById("canvas");var p=r.style.width;var q=r.style.height;imageWidth=p.slice(0,p.length-2);imageHeight=q.slice(0,q.length-2);console.log(p+"-"+q)}$("#canvas").attr({width:imageWidth,height:imageHeight}).css({width:imageWidth,height:imageHeight});select=false;console.log(imageWidth+"-"+imageHeight);console.log("Crop undone.!!")}else{alert("You haven't cropped anything yet")}});$(".reset").click(function(){$(".edit_eventdate_button_container").show();parent.$(".upload-overlay-loading-fix").show();j.src=k;$("#canvas").remove();var p=m.clone();p[0].getContext("2d").drawImage(j,0,0);$(".cell").html(p);Caman("#canvas",k,function(){this.render(function(){parent.$(".upload-overlay-loading-fix").hide()})});$("#canvas").attr({width:originalImageWidth,height:originalImageHeight}).css({width:originalImageWidth,height:originalImageHeight});imageHeight=originalImageHeight;imageWidth=originalImageWidth});$(document).on("click","#save_photo_edit",function(){var u=$(this).attr("data-id");var q=$(this).attr("data-post");if(typeof q==="undefined"||!q){q=0}var p=document.getElementById("canvas");var s=p.toDataURL(mediaType);var r=$("#imgPhoto").css("left");var v=$("#imgPhoto").css("top");r=parseInt(r.substring(0,r.length-2));v=parseInt(v.substring(0,v.length-2));r=parseInt(r*$("#imgPhoto").data("ow")/$("#imgPhoto").width());v=parseInt(v*$("#imgPhoto").data("oh")/$("#imgPhoto").height());v=Math.abs(v);r=Math.abs(r);$.ajax({url:ReturnLink("/ajax/ajax_edit_photo.php"),data:{image64:s,id:u,x:r,y:v,is_post:q},type:"post",success:function(w){parent.$(".upload-overlay-loading-fix").hide();var y=null;try{y=$.parseJSON(w)}catch(x){return}if(y.error==1){TTAlert({msg:y.msg,type:"alert",btn1:t("ok"),btn2:"",btn2Callback:null})}else{setTimeout(function(){parent.window.closeFancyReload(is_album)},1000)}}})});$(document).on("click",".applyRotate",function(){canvas1=document.getElementById("canvas");j.src=canvas1.toDataURL("image/png");imageWidth=canvas1.width;imageHeight=canvas1.height;$(".edit_eventdate_button_container").show();$(this).hide();$(this).next("span").hide()});$("#cancel").click(function(){$(".applyDiv").slideToggle();return false})});