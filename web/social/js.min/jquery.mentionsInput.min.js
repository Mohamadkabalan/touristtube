(function(a,b,f){var d={BACKSPACE:8,TAB:9,RETURN:13,ESC:27,LEFT:37,UP:38,RIGHT:39,DOWN:40,COMMA:188,SPACE:32,HOME:36,END:35};var c={triggerChar:"@",onDataRequest:a.noop,minChars:1,showAvatars:true,elastic:true,addedItems:[],classes:{autoCompleteItemActive:"active"},templates:{wrapper:b.template('<div class="mentions-input-box"></div>'),autocompleteList:b.template('<div class="mentions-autocomplete-list"></div>'),autocompleteListItem:b.template('<li data-ref-id="<%= id %>" data-ref-type="<%= type %>" data-display="<%= display %>"><%= content %></li>'),autocompleteListItemAvatar:b.template('<img src="<%= avatar %>" />'),autocompleteListItemIcon:b.template('<div class="icon <%= icon %>"></div>'),mentionsOverlay:b.template('<div class="mentions"><div></div></div>'),mentionItemSyntax:b.template("@[<%= value %>](<%= type %>:<%= id %>)"),mentionItemHighlight:b.template('<span class="comments_user" data-id="<%= id %>"><%= content %></span>')}};var g={htmlEncode:function(h){return b.escape(h)},highlightTerm:function(i,h){if(!h&&!h.length){return i}return i.replace(new RegExp("(?![^&;]+;)(?!<[^<>]*)("+h+")(?![^<>]*>)(?![^&;]+;)","gi"),"<b>$1</b>")},setCaratPosition:function(i,h){if(i.createTextRange){var j=i.createTextRange();j.move("character",h);j.select()}else{if(i.selectionStart){i.focus();i.setSelectionRange(h,h)}else{i.focus()}}},rtrim:function(h){return h.replace(/\s+$/,"")}};var e=function(J){var k,o,p,n,r,q,m;var y=(J.addedItems)?J.addedItems:[];var i={};var x=[];var j;J=a.extend(true,{},c,J);function w(){o=a(k);if(o.attr("data-mentions-input")=="true"){return}p=o.parent();r=a(J.templates.wrapper());o.wrapAll(r);r=p.find("> div");o.attr("data-mentions-input","true");o.bind("keydown",D);o.bind("keypress",E);o.bind("input",C);o.bind("click",B);o.bind("blur",A);if(J.elastic){o.elastic()}}function u(){n=a(J.templates.autocompleteList());n.appendTo(r);n.delegate("li","mousedown",z)}function v(){q=a(J.templates.mentionsOverlay());q.prependTo(r)}function L(){var N=s();b.each(y,function(O){var P=J.templates.mentionItemSyntax(O);N=N.replace(O.value,P)});var M=g.htmlEncode(N);b.each(y,function(P){var O=b.extend({},P,{value:g.htmlEncode(P.value)});var R=J.templates.mentionItemSyntax(O);var Q=J.templates.mentionItemHighlight({id:g.htmlEncode(P.id),content:g.htmlEncode(P.value)});M=M.replace(R,Q)});M=M.replace(/\n/g,"<br />");M=M.replace(/ {2}/g,"&nbsp; ");o.data("messageText",N);q.find("div").html(M)}function G(){x=[]}function K(){var M=s();y=b.reject(y,function(O,N){return !O.value||M.indexOf(O.value)==-1});y=b.compact(y)}function h(P){var N=s();var Q=new RegExp("\\"+J.triggerChar+j,"gi");Q.exec(N);var S=Q.lastIndex-j.length-1;var M=Q.lastIndex;var R=N.substr(0,S);var O=N.substr(M,N.length);var T=(R+P.value).length+1;y.push(P);G();j="";t();var U=R+P.value+" "+O;o.val(U);L();o.focus();g.setCaratPosition(o[0],T)}function s(){return a.trim(o.val())}function z(M){var N=a(this);var O=i[N.attr("data-uid")];h(O);$textarea_comments.blur();$textarea_comments.focus();return false}function B(M){G()}function A(M){t()}function C(M){L();K();var N=b.lastIndexOf(x,J.triggerChar);if(N>-1){j=x.slice(N+1).join("");j=g.rtrim(j);b.defer(b.bind(l,this,j))}}function E(M){if(M.keyCode!==d.BACKSPACE){var N=String.fromCharCode(M.which||M.keyCode);x.push(N)}}function D(M){if(M.keyCode==d.LEFT||M.keyCode==d.RIGHT||M.keyCode==d.HOME||M.keyCode==d.END){b.defer(G);if(navigator.userAgent.indexOf("MSIE 9")>-1){b.defer(L)}return}if(M.keyCode==d.BACKSPACE){x=x.slice(0,-1+x.length);return}if(!n.is(":visible")){return true}switch(M.keyCode){case d.UP:case d.DOWN:var N=null;if(M.keyCode==d.DOWN){if(m&&m.length){N=m.next()}else{N=n.find("li").first()}}else{N=a(m).prev()}if(N.length){I(N)}return false;case d.RETURN:case d.TAB:if(m&&m.length){m.trigger("mousedown");return false}break}return true}function t(){m=null;n.empty().hide()}function I(M){M.addClass(J.classes.autoCompleteItemActive);M.siblings().removeClass(J.classes.autoCompleteItemActive);m=M}function F(O,P){n.show();var N=b.pluck(y,"value");P=b.reject(P,function(Q){return b.include(N,Q.name)});if(!P.length){t();return}n.empty();var M=a("<ul>").appendTo(n).hide();b.each(P,function(T,S){var U=b.uniqueId("mention_");i[U]=b.extend({},T,{value:T.name});var R=a(J.templates.autocompleteListItem({id:g.htmlEncode(T.id),display:g.htmlEncode(T.name),type:g.htmlEncode(T.type),content:g.highlightTerm(g.htmlEncode((T.name)),O)})).attr("data-uid",U);if(S===0){I(R)}if(J.showAvatars){var Q;if(T.avatar){Q=a(J.templates.autocompleteListItemAvatar({avatar:T.avatar}))}else{Q=a(J.templates.autocompleteListItemIcon({icon:T.icon}))}Q.prependTo(R)}R=R.appendTo(M)});n.show();M.show()}function l(M){if(M&&M.length&&M.length>=J.minChars){J.onDataRequest.call(this,"search",M,function(N){F(M,N)})}else{t()}}function H(){o.val("");y=y=(J.addedItems)?J.addedItems:[];L()}return{init:function(M){k=M;w();u();v();H();if(J.prefillMention){h(J.prefillMention)}},val:function(M){if(!b.isFunction(M)){return}var N=y.length?o.data("messageText"):s();M.call(this,N)},reset:function(){H()},getMentions:function(M){if(!b.isFunction(M)){return}M.call(this,y)},setMentions:function(M){y.push(M)}}};a.fn.mentionsInput=function(h,j){var i=arguments;if(typeof h==="object"||!h){j=h}return this.each(function(){var k=a.data(this,"mentionsInput")||a.data(this,"mentionsInput",new e(j));if(b.isFunction(k[h])){return k[h].apply(this,Array.prototype.slice.call(i,1))}else{if(typeof h==="object"||!h){return k.init.call(this,this)}else{a.error("Method "+h+" does not exist")}}})}})(jQuery,_);