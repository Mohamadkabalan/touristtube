var chatIsOn=true;var ws=null;function ChatEnabled(a){if(typeof a!="undefined"){chatIsOn=a}else{return chatIsOn}}function SendMsgTo(c,a){var b={op:"CHAT",to:c,msg:a,timezone:TimeZone};Communicate(b)}function Communicate(b){if(ws!=null){b.client_ts=getClientTS();var c=JSON.stringify(b,null,2);try{ws.send(c)}catch(a){}}}function Receive(a){if(a.from.length==0){}else{if(chatListLoaded()){if(a.from==CHAT_USER_ID){AddTuberChat(a.to,false);alert("ok")}else{alert("ok");AddTuberChat(a.from,false)}AppendToLog(a)}else{alert("ok");setTimeout(function(){Receive(a)},1000)}}}var SocketOpened=false;function connect(){if(!ChatEnabled()){return}SocketOpened=false;ws=$.gracefulWebSocket(CHAT_SERVER);if(ws==null){setTimeout(function(){connect()},500);return}ws.onclose=function(a){setTimeout(function(){connect()})};ws.onopen=function(a){SocketOpened=true}}var ConnectInterval=null;function getOnlineUserNB(){var a=0;$(".one-chat-rec").each(function(){var b=$(this);if(b.attr("data-chat-status")=="available"){a++}});return a}function replaceTuberSearch(){if($.cookie("openchat")=="false"){var a=getOnlineUserNB();if(a==1){a=t("1 tuber")}else{a=a+" "+t("tubers")}$("#ttsearch").hide();$("#onlineTubersNb").show().html(t("You have %s online",a))}else{$("#onlineTubersNb").hide().html("");$("#ttsearch").show()}}function DisplayChangeStatus(b,a){switch(a){case CHAT_STATUS_OFFLINE:$("#ChatListItem"+b+" div:first").removeClass().addClass("one-chat-img offline");$("#ChatWindow"+b+" .ChatTitle").addClass("leftgrey2").removeClass("leftgreen2 leftred2 leftyellow2");break;case CHAT_STATUS_ONLINE:$("#ChatListItem"+b+" div:first").removeClass().addClass("one-chat-img available");$("#ChatWindow"+b+" .ChatTitle").addClass("leftgreen2").removeClass("leftyellow2 leftred2 leftgrey2");break;case CHAT_STATUS_AWAY:$("#ChatListItem"+b+" div:first").removeClass().addClass("one-chat-img away");$("#ChatWindow"+b+" .ChatTitle").addClass("leftyellow2").removeClass("leftgreen2 leftred2 leftgrey2");break;case CHAT_STATUS_BUSY:$("#ChatListItem"+b+" div:first").removeClass().addClass("one-chat-img busy");$("#ChatWindow"+b+" .ChatTitle").addClass("leftred2").removeClass("leftyellow2 leftgreen2 leftgrey2");break}replaceTuberSearch()}function PostConnect(){if(!SocketOpened){return}replaceTuberSearch();clearInterval(ConnectInterval);ConnectInterval=null;destroyContextMenu();loadChatList();var c=ChatStatusGet();if(!c){c=CHAT_STATUS_ONLINE}var a=JSON.stringify({op:"CONNECT",sid:CHAT_SESSION_ID,status:c},null,2);try{ws.send(a)}catch(b){}ws.onclose=function(e){connect();ConnectInterval=setInterval(function(){PostConnect()},500)};ws.onmessage=function(e){var g=null;try{g=JSON.parse(e.data)}catch(f){}g.from=parseInt(g.from);if(g.from==0){if(g.op=="dc"){DisplayChangeStatus(g.who,0)}else{if(g.op=="con"){DisplayChangeStatus(g.who,g.status)}else{if(g.op=="ch_stat"){DisplayChangeStatus(g.who,g.status)}else{if(g.op=="frnd_req"){TTAlert({msg:t(" got freind request from ")+g.who,type:"alert",btn1:t("ok"),btn2:"",btn2Callback:null})}}}}}else{Receive(g)}}}function ChatStatusGet(){return $.cookie("chatStatus")}function ChatStatusChange(c){var a=JSON.stringify({op:"CH_STAT",status:c},null,2);try{ws.send(a)}catch(b){}}function turnOffChat(){ChatEnabled(false);var a={op:"CLIENT_DISCONNECT"};Communicate(a);$("#chatList").hide().html("");$("#switchatOn").show().fadeIn(10,function(){$("#switchatOn").click(function(){$("#switchatOn").hide();$("#chatList").show();turnOnChat()})})}function turnOnChat(){ChatEnabled(true);connect();ConnectInterval=setInterval(function(){PostConnect()},500);loadChatList()}$(document).ready(function(){$("#historychat").click(function(){var a=$(document).width();var b=ReturnLink("/get_chat_history.php?to=22");$("#chathistorydiv").css("left",(a-700)/2).show().load(b)});turnOnChat();$("#ttsearch").focus(function(){$(this).val("")});$("#ttsearch").blur(function(){$(this).val("Search for a friend to chat with...")});$("#openChatList").click(function(){$("#chatList").toggle();if($("#chatList").css("display")!="none"){$.cookie("openchat","true",{path:"/"});destroyContextMenu();loadChatList()}else{$.cookie("openchat","false",{path:"/"});destroyContextMenu()}replaceTuberSearch()});loadKeyEvents();if($.cookie("openchat")!="false"){$("#chatList").toggle();if($("#chatList").css("display")!="none"){$.cookie("openchat","true",{path:"/"});loadChatList()}}});function destroyContextMenu(){$(".conmn-menu").remove()}function loadKeyEvents(){$("#ttsearch").keypress(function(){instantSearch($(this))});$("#ttsearch").keydown(function(){instantSearch($(this))});$("#ttsearch").keyup(function(){instantSearch($(this))})}function loadChatList(){$("#chatList").load(ReturnLink("/chatlist.php"),function(){loadChatFunctions()})}var ChatWindows=0;var ChatID=null;var USUAL_CHAT_WIDTH=257;var MINIMIZED_CHAT_WIDTH=112;function SizeAllTabs(){var c=$(window).width()-$("#chat-search").width();if(ChatWindows>Math.floor(c/MINIMIZED_CHAT_WIDTH)){var e=parseInt($("div.one-chatLeftList").css("margin-right").replace("px",""));var a=$("div.ChatWindow:visible");var b=0;var f=0;if(a.length!=0){b=a.width();f=(c-b-(ChatWindows+2)*e)/(ChatWindows-1)}else{f=(c-(ChatWindows+2)*e)/ChatWindows}$("div.one-chatLeftList").width(f)}else{$("div.one-chatLeftList").width(MINIMIZED_CHAT_WIDTH)}}function getClientTS(){var g=new Date();var i=g.getFullYear();var e=g.getMonth()+1;var a=g.getDate();var b=g.getHours();var c=g.getMinutes();var f=g.getSeconds();if(b<10){b="0"+b}if(c<10){c="0"+c}if(f<10){f="0"+f}var h=i+"-"+e+"-"+a+" "+b+":"+c+":"+f;return h}function getTS(j){var l,i,e,g,c,m,f,h;if(typeof j!="undefined"){i=j;m=i.getFullYear();g=i.getMonth()+1;c=i.getDate();e=i.getHours();f=i.getMinutes();h=i.getSeconds();if(e<10){e="0"+e}if(f<10){f="0"+f}if(h<10){h="0"+h}var k=new Date();var a=k.getDate();var b=k.getMonth();if((b==g)&&(a==c)){l=e+":"+f+":"+h}else{l=m+"-"+g+"-"+c+" "+e+":"+f+":"+h}}else{i=new Date();e=i.getHours();f=i.getMinutes();h=i.getSeconds();if(e<10){e="0"+e}if(f<10){f="0"+f}if(h<10){h="0"+h}l=e+":"+f+":"+h}return l}function HideChat(){$(".ChatWindow").hide();$("#chatInput").hide();$("#chatList").hide()}var WhichStorage=sessionStorage;function ChatLogSave(b,a){if(typeof WhichStorage!="undefined"){WhichStorage.setItem("log_"+b,a)}}function ChatLogGet(a){if(typeof WhichStorage!="undefined"){return WhichStorage.getItem("log_"+a)}return null}function ChatLogSaveMsgNumber(c,b){if(typeof WhichStorage!="undefined"){var a=ChatLogGetMsgNumber(c);if(a==null){a=1}else{a++}b.find("span").html("&nbsp;"+a);WhichStorage.setItem("log_"+c,a)}}function ChatLogGetMsgNumber(a){if(typeof WhichStorage!="undefined"){return WhichStorage.getItem("log_"+a)}return null}var $ActiveChatLog=null;var $ActiveChatTab=null;var d=new Date();var TimeZone=d.getTimezoneOffset();var ToWho=0;varChatZIndex=10000;function AddTuberChat(n,j){if(typeof j=="undefined"){j=true}if(n.length==0){return}if(!checkIfExist(n)){var l=$("#ChatListItem"+n).attr("data-chat-status");var m=$("#ChatListItem"+n).find(".one-chat-name span").text();if(!m){m="Tuber";l="green"}var i=$("<div class='one-chatLeftList left"+l+"' data-tuber='"+n+"' title='"+m+"'>"+m+"<span></span></div>");$("#chat-leftList").append(i);var b=$('<div class="ChatWindow" id="ChatWindow'+n+'"></div>').css({"z-index":varChatZIndex});$("body").append(b);$(".ChatWindow").hide();var g=$("<div class='one-chat-settings'><div class='one-chat-send-files'>"+t("send files")+"</div></div>");var h=$("<div class='ChatTitle left"+l+"2'>"+m+"</div>");var a=$('<div class="ChatCloseImg" title="Close"></div>');var e=$('<div class="ChatMinimize" title="Minimize"></div>');var f=$('<div class="ChatSet" title="Settings"></div>');h.append(a).append(f).append(e).appendTo(b);var k=ChatLogGet(m);if(k==null){k=""}var c=$("<div class='ChatLog'  id='dataTuber"+n+"'>"+k+"</div>");c.appendTo(b);c.scrollTop(TotalInnerHeight(c));ChatWindows++;b.hide();$chatInput=$("#chatInput");if($chatInput.length==0){$chatInput=$('<input type="text" id="chatInput" value="type something..."/>').css({position:"absolute",width:"244px","z-index":varChatZIndex,display:"none",border:"1px solid #c0c0c2"}).outerHeight(i.outerHeight()).appendTo("body").keyup(function(o){if(o.keyCode==13){var p=$(this).val();if(p==""){return}SendMsgTo(ToWho,p);$(this).val("");$ActiveChatLog.append('<div class="ChatMyMessage"><span class="User">'+t("Me")+'</span><span class="Date">'+getTS()+'</span><br/><span class="Msg">'+EmoticonTextReplace(p)+"</span></div>");$ActiveChatLog.scrollTop(TotalInnerHeight($ActiveChatLog));ChatLogSave($ActiveChatLog.parent().find(".ChatTitle").text(),$ActiveChatLog.html())}})}$quickupload=$("#quickupload");$quickupload=$('<img src="'+AbsolutePath+'/images/quickupload.jpg" id="quickupload">').css({position:"absolute",display:"none","z-index":varChatZIndex+1,cursor:"pointer"}).appendTo("body");initUpload(c.attr("id"));$(window).scroll(function(){if($chatInput.is(":visible")){$(".ChatMinimize").click()}}).resize(function(){if($chatInput.is(":visible")){$(".ChatMinimize").click()}SizeAllTabs()});a.click(function(){ChatWindows--;i.remove();b.remove();$chatInput.hide();$ActiveChatTab=null});e.click(function(){i.removeClass("activeChat");b.hide();$chatInput.hide();SizeAllTabs();$ActiveChatTab=null});i.click(function(){ToWho=n;WhichStorage.setItem("log_"+ToWho+"msgnum",0);i.find("span").html("");if(b.is(":visible")){$(".ChatWindow").hide();b.hide();$ActiveChatLog=null;$ActiveChatTab=null}else{$(".ChatWindow").hide();b.show();$ActiveChatLog=c;$ActiveChatTab=i}SizeAllTabs();i.removeClass("activeChat");var o=i.css("padding-left");o=parseInt(o.replace("px",""));if(b.is(":visible")){i.width(USUAL_CHAT_WIDTH);var p=i.offset();b.css({top:p.top-b.outerHeight(true),left:p.left});$chatInput.val("").css({top:p.top,left:p.left}).show().focus();$quickupload.css({top:p.top,left:p.left+5}).show();$ActiveChatLog.scrollTop(TotalInnerHeight($ActiveChatLog))}});if(j){i.click();$ActiveChatLog.scrollTop(TotalInnerHeight($ActiveChatLog))}}}function TotalInnerHeight(a){var b=0;a.children().each(function(){b+=$(this).height()});return b}function daysInMonth(b,c){var a=[31,28,31,30,31,30,31,31,30,31,30,31];if(b!=1){return a[b]}if(c%4!=0){return a[1]}if(c%100==0&&c%400!=0){return a[1]}return a[1]+1}function ActivateTab(a){if(($ActiveChatTab!=null)&&($ActiveChatTab.attr("tt:id")==a)){return}$("#chat-leftList").find("div.one-chatLeftList").each(function(){if(($(this).attr("data-tuber")==a)){if(!$("#ChatWindow"+a).is(":visible")){ChatLogSaveMsgNumber(a+"msgnum",$(this))}if(!$(this).hasClass("activeChat")){$(this).addClass("activeChat")}}})}function AppendToLog(g){if(g.from.length==0){return}var e=g.from;var l=g.to;var j=g.msg;var m="";if(typeof g.ts!="undefined"){m=g.ts;var n=m.split("-");var r=parseInt(n[0]);var i=parseInt(n[1])-1;var c=parseInt(n[2]);var f=parseInt(n[3]);var h=parseInt(n[4]);var k=parseInt(n[5]);h-=TimeZone;if(h<0){h+=60;f--}if(f<0){f+=24;c--}if(c<=0){i--;if(i<0){i=11;r--}c=daysInMonth(i,r)}var o=new Date(r,i,c,f,h,k);m=getTS(o)}else{m=getTS()}if(e==CHAT_USER_ID){ActivateTab(l);var b;var p="Me";var q=$("#ChatListItem"+l).find(".one-chat-name span").text();b='<div class="ChatMyMessage"><span class="User">'+p+'</span><span class="Date">'+m+'</span><br/><span class="Msg">'+EmoticonTextReplace(j)+"</span></div>";var a=$("#ChatWindow"+l).find("div.ChatLog");a.append(b);a.scrollTop(TotalInnerHeight(a));ChatLogSave(q,a.html())}else{ActivateTab(e);var b;var p=$("#ChatListItem"+e).find(".one-chat-name span").text();b='<div class="ChatHisMessage"><span class="User">'+p+'</span><span class="Date">'+m+'</span><br/><span class="Msg">'+EmoticonTextReplace(j)+"</span></div>";var a=$("#ChatWindow"+e).find("div.ChatLog");a.append(b);a.scrollTop(TotalInnerHeight(a));ChatLogSave(p,a.html())}}function loadChatFunctions(){$("#chatSetButton").click(function(){if(!($("#chatSettingsList").is(":visible"))){showChatSettings()}else{hideChatSettings()}})}function showChatSettings(){$("#chatList").unbind("click");$("#chatSetButton").css("background","url(../images/settings-for-chat-hover.jpg)");$("#chatSettingsList").fadeIn(10,function(){$("#turnOffChat").click(function(){turnOffChat()});$("#chatList").click(function(){hideChatSettings()})})}function hideChatSettings(){$("#chatSetButton").css("background","url(../images/settings-for-chat.jpg)");$("#chatSettingsList").hide()}function instantSearch(b){var c=b.val();if(c==""){$(".one-chat-rec").show()}else{var a=$(".one-chat-rec").size();if(a==0){$("#chatList").show();if($("#chatList").css("display")!="none"){loadChatList()}}$("#chatList").show();$(".one-chat-rec").each(function(){var e=$(this).find(".one-chat-name").html();e=(e).toLowerCase();if(e.indexOf(c)!=-1){$(this).show()}else{$(this).hide()}})}}function checkIfExist(b){var a=false;$(".one-chatLeftList").each(function(){if($(this).attr("data-tuber")==b){a=true}});return a}function chatListLoaded(){return($("#chatList").text()!="")};