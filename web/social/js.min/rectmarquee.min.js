var Marquee=Class.create();Marquee.prototype={BASE:1,MARQUEE:2,OPACITY:4,EDGE:8,items:[],options:{},maxZIndex:1,ratio:0,initialize:function(a){this.onFinishDrag=this.finishDrag.bindAsEventListener(this);this.onUpdateDrag=this.updateDrag.bindAsEventListener(this);this.onWindResize=this.render.bindAsEventListener(this);this.onKeyPressed=this.keyPress.bindAsEventListener(this);Event.observe(document,"mouseup",this.onFinishDrag);Event.observe(document,"mousemove",this.onUpdateDrag);Event.observe(window,"resize",this.onWindResize);if(a){this.add(a,arguments[1])}},add:function(j){j=$(j);if(!j){return}var u=Object.extend({ratio:0,preview:false,previewWidth:120,previewHeight:120,onUpdate:null,onBeforeUpdate:null,color:"black",opacity:0.75,type:"crop",allowResize:true,allowHotKeys:true,hideEdges:false,coords:{x1:0,y1:0,x2:0,y2:0,width:0,height:0}},arguments[1]||{});var k=this.items.length;this.activeId=k;var l=document.createElement("DIV");l.className="marquee-landing";l.mtype=this.BASE;l.id="rmt_landing_"+k;l.onselectstart=this._bibb;var w=Position.positionedOffset(j);Element.setStyle(l,{width:j.offsetWidth+"px",height:j.offsetHeight+"px",zIndex:this.getMaxZIndex(),left:w[0]+"px",top:w[1]+"px"});var n=document.createElement("DIV");n.className="marquee-element";n.mtype=this.MARQUEE;n.id="rmt_marquee_"+k;n.onselectstart=this._bibb;Element.hide(n);var y=document.createElement("DIV");y.className="marquee-window";y.id="rmt_window_"+k;y.mtype=this.MARQUEE;y.number=5;y.onselectstart=this._bibb;n.appendChild(y);var o=document.createElement("DIV");o.className="marquee-opacity";o.mtype=this.OPACITY;o.onselectstart=this._bibb;var p=o.cloneNode(true);p.mtype=this.OPACITY;p.onselectstart=this._bibb;Element.setStyle(p,{left:0});var q=o.cloneNode(true);q.mtype=this.OPACITY;q.onselectstart=this._bibb;Element.setStyle(q,{right:0});var r=o.cloneNode(true);r.mtype=this.OPACITY;r.onselectstart=this._bibb;Element.setStyle(o,{top:0,left:0,width:"100%"});Element.setStyle(r,{bottom:0,left:0,width:"100%"});n.o1=o;n.o2=p;n.o3=q;n.o4=r;var m=document.createElement("INPUT");m.className="marquee-listener";m.style.zIndex=this.getMaxZIndex();m.onselectstart=this._bibb;m.id="rmt_listener_"+k;m.type="hidden";Event.observe(m,"keydown",this.onKeyPressed);var a=document.createElement("DIV");a.className="marquee-edge";a.onselectstart=this._bibb;var b=a.cloneNode(true);b.number=1;b.mtype=this.EDGE;n.appendChild(b);Element.setStyle(b,{left:"0%",top:"0%",cursor:"nw-resize"});var c=a.cloneNode(true);c.number=2;c.mtype=this.EDGE;n.appendChild(c);Element.setStyle(c,{left:"50%",top:"0%",cursor:"n-resize"});var d=a.cloneNode(true);d.number=3;d.mtype=this.EDGE;n.appendChild(d);Element.setStyle(d,{left:"100%",top:"0%",cursor:"ne-resize"});var e=a.cloneNode(true);e.number=4;e.mtype=this.EDGE;n.appendChild(e);Element.setStyle(e,{left:"0%",top:"50%",cursor:"w-resize"});var f=a.cloneNode(true);f.number=6;f.mtype=this.EDGE;n.appendChild(f);Element.setStyle(f,{left:"100%",top:"50%",cursor:"w-resize"});var g=a.cloneNode(true);g.mtype=this.EDGE;g.number=7;n.appendChild(g);Element.setStyle(g,{left:"0%",top:"100%",cursor:"ne-resize"});var h=a.cloneNode(true);h.number=8;h.mtype=this.EDGE;Element.setStyle(h,{left:"50%",top:"100%",cursor:"n-resize"});n.appendChild(h);var i=a.cloneNode(true);i.number=9;i.mtype=this.EDGE;Element.setStyle(i,{left:"100%",top:"100%",cursor:"nw-resize"});n.appendChild(i);n.number=5;l.appendChild(o);l.appendChild(p);l.appendChild(q);l.appendChild(r);l.appendChild(n);l.appendChild(m);j.parentNode.insertBefore(l,j);var x=$(u.preview);if(x){var v=new Image();v.src=j.tagName=="IMG"?j.src:j.style.backgroundImage;v.className="marquee-preview";x.appendChild(v);Element.setStyle(x,{overflow:"hidden",position:x.style.position=="absolute"?"absolute":"relative",width:0,height:0,fontSize:"1px",lineHeight:"0%"})}u.onLandClick=t;this.items.push({id:k,marquee:n,element:j,coords:u.coords,wind:y,options:u,preview:x,pImage:v,listener:m,zIndex:this.getMaxZIndex()});this.setRatio(u.ratio);this.maxZIndex++;this.setOpacity(u.opacity);this.setColor(u.color);this.setType(u.type);if(u.hideEdges){this.hideEdges()}if(u.coords.width||u.coords.x2){this.setCoords(u.coords.x1,u.coords.y1,u.coords.width?u.coords.width:u.coords.x2-u.coords.x1,u.coords.height?u.coords.height:u.coords.y2-u.coords.y1)}var t=this.initDrag.bind(this,k);var s=this.setFocus.bind(this,k);Event.observe(l,"mousedown",t);Event.observe(l,"mouseup",s)},setFocus:function(a){if(!this.getOption(a,"allowHotKeys")){return}var b=this.items[a].listener;b.focus()},setRandomColor:function(){var a=["0","1","2","3","4","5","6","7","8","9","a","b","c","d","e","f"];var b=Math.round(Math.random()*15);var c=Math.round(Math.random()*15);var d=Math.round(Math.random()*15);this.setColor("#"+a[b]+a[c]+a[d])},enable:function(a){Event.observe(this.getMarquee(a).parentNode,"mousedown",this.getOption(a,"onLandClick"))},disable:function(a){Event.stopObserving(this.getMarquee(a).parentNode,"mousedown",this.getOption(a,"onLandClick"))},getId:function(){return this.activeId},accessResize:function(a,b){a=(a==undefined)?true:false;this.setOption(b,"allowResize",a);if(a){this.showEdges(b)}else{this.hideEdges(b)}},accessHotKeys:function(a,b){a=(a==undefined)?true:false;this.setOption(b,"allowHotKeys",a)},getMaxZIndex:function(){return this.maxZIndex},setRatio:function(b){this.items[this.activeId].options.ratio=b;var a=this.items[this.activeId].marquee;if(!this.getOption(this.activeId,"allowResize")||this.getOption(this.activeId,"hideEdges")){return}$A(a.childNodes).each(function(c){if(c.className&&c.className=="marquee-edge"){c.style.display=(c.number%2==0)&&b?"none":"block"}})},getRatio:function(a){return this.ratio?this.ratio:this.items[a||this.activeId].options.ratio},initDrag:function(c,b){b=b||window.event;if(!b){return}var a=Event.element(b);var e=this.getMarquee(c);if(!e||!a.mtype){return}var d=this.getElement(c);this.dragging=true;Position.prepare();Element.show(e);this.startPosition=Position.cumulativeOffset(d);this.startOffset=Position.positionedOffset(e);this.startDimension=Element.getDimensions(e);this.startMovingPoint=[Event.pointerX(b)-this.startPosition[0],Event.pointerY(b)-this.startPosition[1]];this.activeEdge=a.number;this.activeId=c;if(a.mtype&(this.OPACITY|this.BASE)){this.startOffset=this.startMovingPoint}Event.stop(b)},_bibb:function(a){return false},updateDrag:function(b){if(!this.dragging){return}this._currentTime=new Date();if((this._currentTime-this._lastUpdate)<32){return}this._lastUpdate=new Date();var d=this.items[this.activeId].options;if(typeof d.onBeforeUpdate=="function"&&!d.onBeforeUpdate()){return}var f=this.getRatio();if(b.shiftKey&&!f){this.ratio=1}var e=[Event.pointerX(b)-this.startPosition[0],Event.pointerY(b)-this.startPosition[1]];var g=[e[0]-this.startMovingPoint[0],e[1]-this.startMovingPoint[1]];switch(this.activeEdge){case 1:g=this.snap(g[0],g[1],1);var c={width:this.startDimension.width-g[0],height:this.startDimension.height-g[1]};if(c.width-2<0){g[0]+=c.width-2}if(c.height-2<0){g[1]+=c.height-2}break;case 2:var c={width:this.startDimension.width,height:this.startDimension.height-g[1]};g[0]=0;if(c.height-2<0){g[1]+=c.height-2}break;case 3:g=this.snap(g[0],g[1],-1);var c={width:this.startDimension.width+g[0],height:this.startDimension.height-g[1]};g[0]=0;if(c.width-2<0){g[0]+=c.width-2}if(c.height-2<0){g[1]+=c.height-2}break;case 4:var c={width:this.startDimension.width-g[0],height:this.startDimension.height};g[1]=0;if(c.width-2<0){g[0]+=c.width-2}break;case 6:var c={width:this.startDimension.width+g[0],height:this.startDimension.height};g[0]=0;g[1]=0;if(c.width-2<0){g[0]+=c.width-2}break;case 7:g=this.snap(g[0],g[1],-1);var c={width:this.startDimension.width-g[0],height:this.startDimension.height+g[1]};g[1]=0;if(c.width-2<0){g[0]+=c.width-2}if(c.height-2<0){g[1]+=c.height-2}break;case 8:var c={width:this.startDimension.width,height:this.startDimension.height+g[1]};g[0]=0;g[1]=0;if(c.height-2<0){g[1]+=c.height-2}break;case 9:g=this.snap(g[0],g[1],1);var c={width:this.startDimension.width+g[0],height:this.startDimension.height+g[1]};g[0]=0;g[1]=0;if(c.width-2<0){g[0]+=c.width-2}if(c.height-2<0){g[1]+=c.height-2}break;case 5:var c={width:this.startDimension.width,height:this.startDimension.height};break;default:g=this.snap(g[0],g[1],(g[1]&&g[0]/g[1]<0?-1:1));if(!this.getOption(this.activeId,"allowResize")){return}var c={width:g[0],height:g[1]};if(c.width-2>=0){g[0]=0}if(c.height-2>=0){g[1]=0}c.width+=2;c.height+=2}c.width-=2;c.height-=2;if(this.activeEdge!=5){var a=this.getElement(this.activeId);if(this.startOffset[0]+g[0]+c.width>a.offsetWidth){c.width=a.offsetWidth-this.startOffset[0]-g[0];if(f){c.height=c.width/f}}else{if(this.startOffset[0]+g[0]-c.width>a.offsetWidth){c.width=a.offsetWidth-this.startOffset[0]-this.startDimension.width;if(f){c.height=c.width/f}}else{if(this.startOffset[0]+g[0]<0&&c.width>0){c.width=this.startOffset[0]+this.startDimension.width-2;if(f){c.height=c.width/f}}else{if(this.startOffset[0]+g[0]<0&&c.width<0){c.width=this.startOffset[0];if(f){c.height=c.width/f}}}}}if(this.startOffset[1]+g[1]+c.height>a.offsetHeight){c.height=a.offsetHeight-this.startOffset[1];if(f){c.width=c.height*f}}else{if(this.startOffset[1]+g[1]-c.height>a.offsetHeight){c.height=a.offsetHeight-this.startOffset[1]-this.startDimension.height;if(f){c.width=c.height*f}}else{if(this.startOffset[1]+g[1]<0&&c.height>0){c.height=this.startOffset[1]+this.startDimension.height-2;if(f){c.width=c.height*f}}else{if(this.startOffset[1]+g[1]<0&&c.height<0){c.height=this.startOffset[1];if(f){c.width=c.height*f}}}}}}this.setCoords(this.startOffset[0]+g[0],this.startOffset[1]+g[1],c.width,c.height);if(b.shiftKey){this.ratio=0}Event.stop(b);if(typeof d.onUpdate=="function"){d.onUpdate()}},setOpacity:function(b){var a=this.items[this.activeId];Element.setOpacity(a.wind,b);Element.setOpacity(a.marquee.o1,b);Element.setOpacity(a.marquee.o2,b);Element.setOpacity(a.marquee.o3,b);Element.setOpacity(a.marquee.o4,b);this.setOption(a.id,"opacity",b)},setColor:function(a){var b=this.items[this.activeId];a=a||b.color;this.items[this.activeId].color=a;if(b.type=="crop"||b.type=="window"){Element.setStyle(b.marquee.o1,{backgroundColor:a});Element.setStyle(b.marquee.o2,{backgroundColor:a});Element.setStyle(b.marquee.o3,{backgroundColor:a});Element.setStyle(b.marquee.o4,{backgroundColor:a});Element.setStyle(b.wind,{backgroundColor:""})}else{if(b.type=="rect"||b.type=="marquee"){Element.setStyle(b.wind,{backgroundColor:a});Element.setStyle(b.marquee.o1,{backgroundColor:""});Element.setStyle(b.marquee.o2,{backgroundColor:""});Element.setStyle(b.marquee.o3,{backgroundColor:""});Element.setStyle(b.marquee.o4,{backgroundColor:""})}else{Element.setStyle(b.wind,{backgroundColor:""});Element.setStyle(b.marquee.o1,{backgroundColor:""});Element.setStyle(b.marquee.o2,{backgroundColor:""});Element.setStyle(b.marquee.o3,{backgroundColor:""});Element.setStyle(b.marquee.o4,{backgroundColor:""})}}},keyPress:function(b){var c=b.keyCode||b.which||b.button;switch(c){case 27:this.unselectAll();break;case 37:this.moveLeft(b.shiftKey?10:1,b.ctrlKey);break;case 38:if(b.altKey){var d=this.getOption(this.activeId,"opacity");this.setOpacity(d<0.95?d+0.05:1)}else{this.moveTop(b.shiftKey?10:1,b.ctrlKey)}break;case 39:this.moveRight(b.shiftKey?10:1,b.ctrlKey);break;case 40:if(b.altKey){var d=this.getOption(this.activeId,"opacity");this.setOpacity(d>0.05?d-0.05:0)}else{this.moveBottom(b.shiftKey?10:1,b.ctrlKey)}break;case 65:this.selectAll();break;case 69:this.switchEdges();break;case 73:this.inverse();break;case 78:if(b.shiftKey){this.add(this.getElement(),this.items[this.activeId].options)}break;case 90:this.zoom(b.shiftKey?10:1,b.ctrlKey);break;case 82:this.setRandomColor();break;case 83:this.select();break;case 49:case 50:case 51:case 52:case 53:case 54:case 55:case 56:case 57:case 48:if(b.shiftKey){var a=["00f","000","ffc","cfc","0f0","0ff","f00","f0f","ff0","fff"];this.setColor("#"+a[c-48])}break}},setType:function(a){this.items[this.activeId].type=a;this.setColor()},getType:function(a){return this.items[a||this.activeId].type},snap:function(c,d,a){var b=this.getRatio();return b?[d*b*a,d]:[c,d]},getWindow:function(a){return this.items[a||this.activeId].wind},getMarquee:function(a){return this.items[a||this.activeId].marquee},getElement:function(a){return this.items[a||this.activeId].element},getCoords:function(a){return this.items[a||this.activeId].coords},moveRight:function(a,c){var b=this.getCoords();this.setCoords(c?b.x1:b.x1+a,b.y1,c?b.width+a:b.width,b.height)},moveLeft:function(a,c){var b=this.getCoords();this.setCoords(c?b.x1:b.x1-a,b.y1,c?b.width-a:b.width,b.height)},moveTop:function(a,c){var b=this.getCoords();this.setCoords(b.x1,c?b.y1:b.y1-a,b.width,c?b.height-a:b.height)},moveBottom:function(a,c){var b=this.getCoords();this.setCoords(b.x1,c?b.y1:b.y1+a,b.width,c?b.height+a:b.height)},zoom:function(a,c){var b=this.getCoords();var d=c?1:-1;this.setCoords(b.x1+d*a,b.y1+d*a,b.width-2*d*a,b.height-2*d*a)},inverse:function(){var a=this.getType();this.setType(a=="window"||a=="crop"?"rect":"crop")},unselectAll:function(){this.setCoords(0,0,0,0);this.hideEdges()},selectAll:function(){var a=this.getElement();this.setCoords(0,0,a.offsetWidth,a.offsetHeight);this.showEdges()},switchEdges:function(){var b=this.activeId;var a=this.getOption(b,"hideEdges");this.setOption(b,"hideEdges",!a);if(a){this.showEdges()}else{this.hideEdges()}},showEdges:function(a){if(!this.getOption(a,"allowResize")||this.getOption(a,"hideEdges")){return}var b=this.getMarquee(a);$A(b.childNodes).each(function(c){if(c.className&&c.className=="marquee-edge"){Element.setStyle(c,{display:""})}})},hideEdges:function(a){var b=this.getMarquee(a);$A(b.childNodes).each(function(c){if(c.className&&c.className=="marquee-edge"){Element.setStyle(c,{display:"none"})}})},select:function(c){var b=this.items[this.activeId];if(this.items[c]){this.activeId=c}else{var d=[],f=0,a=0;$A(this.items).each((function(j){if(j.id>f){f=j.id}if(this.activeId==j.id){a=d.length}d.push(j.id)}).bind(this));if(d.length>1){this.activeId=(f==this.activeId)?d[0]:d[a+1]}}if(this.activeId!==c&&this.items.length>1){var h=this.items[this.activeId];var g=b.zIndex;this.items[b.id].zIndex=h.zIndex;Element.setStyle(this.items[b.id].marquee.parentNode,{zIndex:h.zIndex});var e=this.getMarquee();var i=this.getWindow();this.items[this.activeId].zIndex=g;Element.setStyle(e.parentNode,{zIndex:g});Element.setStyle(i,{border:"2px solid black"});setTimeout(function(){Element.setStyle(i,{border:""})},250)}},hide:function(a){var b=this.getMarquee(a);Element.hide(b.parentNode);this.setOption(a,"hidden",true)},show:function(a){var b=this.getMarquee(a);Element.show(b.parentNode);this.setOption(a,"hidden",false)},setOption:function(a,b,c){this.items[a||this.activeId].options[b]=c},getOption:function(a,b){return this.items[a||this.activeId].options[b]},render:function(b){if(this.activeId==undefined){return}var a=this.getElement();var c=this.getMarquee();var d=Position.positionedOffset(a);Element.setStyle(c.parentNode,{width:a.offsetWidth+"px",height:a.offsetHeight+"px",left:d[0]+"px",top:d[1]+"px"})},snapRatio:function(c,a){var b;if(b=this.getRatio()){if(c<a){a=Math.floor(c/b)}else{c=Math.floor(a*b)}}return[c,a]},setCoords:function(s,t,q,b){var g=this.items[this.activeId].options.coords.width;var f=this.items[this.activeId].options.coords.height;q=Math.abs(q);b=Math.abs(b);var d=Math.abs(1024-q);var e=Math.abs(600-b);if(s<0){s=0}if(s>d){s=d}if(t<0){t=0}if(t>e){t=e}if(q<=g){q=g}if(b<=f){b=f}var a=this.getElement();if(q>a.offsetWidth){q=a.offsetWidth}if(b>a.offsetHeight){b=a.offsetHeight}if(s+q>a.offsetWidth){s=a.offsetWidth-q}if(t+b>a.offsetHeight){t=a.offsetHeight-b}var p=this.snapRatio(q,b);q=p[0];b=p[1];this.items[this.activeId].coords={x1:s,y1:t,x2:s+q,y2:t+b,width:q,height:b};var c=this.getMarquee(this.activeId);Element.setStyle(c,{width:q+"px",height:b+"px",left:s+"px",top:t+"px",display:"block"});Element.setStyle(this.getWindow(this.activeId),{height:b+"px"});Element.setStyle(c.o1,{height:t+1+"px"});Element.setStyle(c.o2,{height:b+"px",width:s+"px",top:t+1+"px"});Element.setStyle(c.o3,{height:b+"px",width:((tmp=a.offsetWidth-s-q-1)>0?tmp:0)+"px",top:t+1+"px"});Element.setStyle(c.o4,{top:b+t+1+"px",height:((tmp=a.offsetHeight-t-b-1)>0?tmp:0)+"px"});if(this.items[this.activeId].options.preview){var n=this.items[this.activeId].options.previewWidth;var m=this.items[this.activeId].options.previewHeight;var o=Math.min(q?n/q:0,b?m/b:0);if(o>1){o=1}var j=q*o;var i=b*o;var k=s*o;var l=t*o;Element.setStyle(this.items[this.activeId].preview,{width:j+"px",height:i+"px"});Element.setStyle(this.items[this.activeId].pImage,{width:this.items[this.activeId].element.offsetWidth*o+"px",height:this.items[this.activeId].element.offsetHeight*o+"px",left:-k+"px",top:-l+"px"})}},finishDrag:function(){if(!this.dragging){return}this.dragging=false;this.setRatio(this.getRatio())},setOnUpdateCallback:function(a){if(this.activeId==undefined){return}this.setOption(this.activeId,"onUpdate",a)},setOnBeforeUpdateCallback:function(a){if(this.activeId==undefined){return}this.setOption(this.activeId,"onBeforeUpdate",a)}};if(!Element.setOpacity){Element.setOpacity=function(a,b){a=$(a);if(b==1){Element.setStyle(a,{opacity:(/Gecko/.test(navigator.userAgent)&&!/Konqueror|Safari|KHTML/.test(navigator.userAgent))?0.999999:null});if(/MSIE/.test(navigator.userAgent)){Element.setStyle(a,{filter:Element.getStyle(a,"filter").replace(/alpha\([^\)]*\)/gi,"")})}}else{if(b<1e-05){b=0}Element.setStyle(a,{opacity:b});if(/MSIE/.test(navigator.userAgent)){Element.setStyle(a,{filter:Element.getStyle(a,"filter").replace(/alpha\([^\)]*\)/gi,"")+"alpha(opacity="+b*100+")"})}}}};