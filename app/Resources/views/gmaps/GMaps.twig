<!DOCTYPE HTML>
<html>
    <head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
	<title>{{ mapName }}</title>
	<script type="text/javascript" src="/assets/vendor/jquery/dist/jquery-1.9.1.min.js"></script>
	<script type="text/javascript" src="//maps.googleapis.com/maps/api/js?v3&key=AIzaSyCL53RGsSAL-vteodkWJJZCaRksk3HB02E&sensor=false"></script>
	{% if showInfobox %}
	    <script type="text/javascript" src="{{ asset("/assets/common/js/infobox_packed.js")|raw }}"></script>
	{% endif %}
	<link rel="stylesheet" type="text/css" href="{{ asset("/assets/common/css/gmaps.css")|raw }}" >
    </head>
    <body id="body">
	<script type="text/javascript">
	    var markersArrayData = [];
	    var markersArrayDataTarget = [];
	    var boxText;
		    var showInfoBox = {{ showInfobox }};
		    var data = {{ data|json_encode()|raw }};
		    var zoomdefault = {{ zoomdefault }};
	    var latdefault = "{{ latdefault }}";
	    var longdefault = "{{ longdefault }}";
	    var type = "{{ type }}";
	    var markerImage = "{{ markerImage }}";
	    var markerImageBlue = "{{ markerImageBlue }}";

	    $(document).ready(function (e) {
		var pagedimensions = [500, 500];
		try {
		    pagedimensions = parent.returnWindowDMMap();
		} catch (err) {
		    parent.postMessage({event_id: 'returnWindowDMMap'}, "*");
		}
		$('#body').css('width', pagedimensions[0] + 'px');
		$('#body').css('height', pagedimensions[1] + 'px');
		var id_location = $('.googlemap').attr('id');
		var myStyles = [{
			featureType: "poi",
			elementType: "labels",
			stylers: [{visibility: "off"}]
		    }];
		var mapOptions = {
		    center: new google.maps.LatLng(latdefault, longdefault),
		    zoom: zoomdefault,
		    disableDefaultUI: true,
		    mapTypeId: google.maps.MapTypeId.ROADMAP,
		    styles: myStyles
		};
		var map = new google.maps.Map(document.getElementById(id_location), mapOptions);
		
		if (showInfoBox) {
		    boxText = document.createElement("div");
		    var myOptions = {
			content: boxText
			, disableAutoPan: false
			, maxWidth: 0
			, pixelOffset: new google.maps.Size(-140, 0)
			, zIndex: null
			, boxStyle: {
			    opacity: 0.9
			    , width: "120px"
			    , height: "140px"
			}
			, closeBoxURL: ""
			, infoBoxClearance: new google.maps.Size(1, 1)
			, isHidden: false
			, pane: "floatPane"
			, enableEventPropagation: false
		    };
		    ib = new InfoBox(myOptions);
		    var images = '';
		    for (var j = 0; j < data.length; ) {
			item = data[j];
			j++;
			price = (typeof item['price'] === 'undefined') ? '' : item['price'];

			images = '';
			if (j == 1) {
			    if( typeof item['markerImage'] !== 'undefined' && item['markerImage'] !='' )
			    {
				images = new google.maps.MarkerImage(item['markerImage']);
			    } else {
				images = new google.maps.MarkerImage(markerImage);
			    }			    
			    markersArrayDataTarget.push(Array(map, images, item['name'], item['link'], item['img'], item['latitude'], item['longitude'], parseInt(item['stars']), price));
			} else {
			    if( typeof item['markerImage'] !== 'undefined' && item['markerImage'] !='' )
			    {
				images = new google.maps.MarkerImage(item['markerImage']);
			    } else {
				images = new google.maps.MarkerImage(markerImageBlue);
			    }			    
			    markersArrayData.push(Array(map, images, item['name'], item['link'], item['img'], item['latitude'], item['longitude'], parseInt(item['stars']), price));
			}
		    }

		    markersArrayData.push(markersArrayDataTarget[0]);
		    setTimeout(function () {
			for (var k = 0; k < markersArrayData.length; k++) {
			    var data_arr = markersArrayData[k];
			    drawmarkers(data_arr[0], data_arr[1], data_arr[2], data_arr[3], data_arr[4], data_arr[5], data_arr[6], data_arr[7], data_arr[8]);
			}
		    }, 3000);
		    google.maps.event.addListener(map, 'click', function () {
			ib.close();
		    });
		} else {
		    for (var j = 0; j < data.length; ) {
			item = data[j];
			var marker = new google.maps.Marker({
			    position: new google.maps.LatLng(item['latitude'], item['longitude']),
			    map: map,
			    icon: new google.maps.MarkerImage(markerImage),
			    title: addslashes(htmlEntityDecode(item['name']))
			});
		    }
		}
	    });
	    function drawmarkers(map, image, title, link_uri, img_uri, la, lo, stars, price) {		
		var marker = new google.maps.Marker({
		    position: new google.maps.LatLng(la, lo),
		    map: map,
		    icon: image,
		    title: title
		});
		var base_url = '';
		var onMarkerClick = function () {
		    ib.close();
		    var marker = this;
		    var content = '<div class="mtooltip"><div class="mtooltipin"><div class="clsgoo" onClick="ib.close();">X</div>';
		    if (img_uri != '') {
			content += '<img class="mtooltipbig" src="' + img_uri + '" alt="" width="72"/>';
			content += '<br /><a href="' + link_uri + '" target="_blank">';
		    }
		    content += '<div class="mtooltip_title">' + title + '</div>';
		    if (img_uri != '') {
			content += '</a>';
		    }
		    if (parseInt(stars) > 0 && parseInt(stars) <= 5) {
			content += '<div class="anchor_star anchor_star' + stars + '"></div>';
		    }
		    if (price != '') {
			content += '<div class="mtooltip_title">' + price + '</div>';
		    }
		    content += '</div>';
		    //content += '<div class="anchor_bk"></div>';
		    content += '</div>';
		    boxText.innerHTML = content;
		    ib.open(map, marker);
		};
		google.maps.event.addListener(marker, 'click', onMarkerClick);
	    }
	    window.addEventListener("message", function (event) {
		if (event.data.event_id === 'windowDMMap') {
		    pagedimensions = event.data.data;
		    $('#body').css('width', pagedimensions[0] + 'px');
		    $('#body').css('height', pagedimensions[1] + 'px');
		}
	    });
	</script>
	<div id="googlemap" class="googlemap"></div>
    </body>
</html>
